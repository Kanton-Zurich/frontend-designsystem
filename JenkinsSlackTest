pipeline {
  agent any
  tools {nodejs "node"}
  environment {
    SLACK_CREDENTIALS = 'slack_auth_token_zhch'
    SLACK_TEAM_DOMAIN = 'zhch'
    SLACK_CHANNEL = '#frontend'
  }
  stages {
    stage('build') {
      steps {
          sh 'echo "Test build"'
          script {
            env.BUILD_LOG_FULL = sh (
                script: "npm -v",
                returnStdout: true
            )
          }
          sh "echo '${env.BUILD_LOG_FULL}' >> log.txt"
      }
    }
  }
  post {
    success {
      def slackResponse = slackSend(
        tokenCredentialId: "${env.SLACK_CREDENTIALS}",
        teamDomain: "${env.SLACK_TEAM_DOMAIN}",
        channel: "${env.SLACK_CHANNEL}",
        botUser: true,
        color: 'good',
        message: "Test Success"
      )
      def slackUploadResponse = slackUploadFile(
        credentialId: "${env.SLACK_CREDENTIALS}",
        channel: slackResponse.threadId,
        filePath: 'log.txt',
        initialComment: 'Build log'
      )
    }
    failure {
      slackSend(
        tokenCredentialId: "${env.SLACK_CREDENTIALS}",
        teamDomain: "${env.SLACK_TEAM_DOMAIN}",
        channel: "${env.SLACK_CHANNEL}",
        botUser: true,
        color: 'danger',
        message: "Test Fail"
      )
    }
  }
}
