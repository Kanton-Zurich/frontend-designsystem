pipeline {
  agent any
  tools {nodejs "node"}
  environment {
    SLACK_CREDENTIALS = 'slack_auth_token_zhch'
    SLACK_TEAM_DOMAIN = 'zhch'
    SLACK_CHANNEL = '#frontend'
  }
  stages {
    stage('build') {
      steps {
          sh 'echo "Test build"'
          script {
            env.BUILD_LOG_FULL = sh (
                script: "npm -v",
                returnStdout: true
            )
          }
          sh "echo ${env.BUILD_LOG_FULL} > log.txt"
          sh "echo "output"
          sh "cat log.txt"
      }
    }
  }
  post {
    success {
      slackSend(
        tokenCredentialId: "${env.SLACK_CREDENTIALS}",
        teamDomain: "${env.SLACK_TEAM_DOMAIN}",
        channel: "${env.SLACK_CHANNEL}",
        botUser: true,
        color: 'good',
        attachments: [
          [
           text: currentBuild.rawBuild.log,
           fallback: 'Logfile',
           color: '#00FF00'
          ],
        ],
        message: "Test Success"
      )
    }
    failure {
      slackSend(
        tokenCredentialId: "${env.SLACK_CREDENTIALS}",
        teamDomain: "${env.SLACK_TEAM_DOMAIN}",
        channel: "${env.SLACK_CHANNEL}",
        botUser: true,
        color: 'danger',
        attachments: [
          [
           text: "${BUILD_URL}/consoleText",
           fallback: 'Logfile',
           color: '#FF0000'
          ],
        ],
        message: "Test Fail"
      )
    }
  }
}
