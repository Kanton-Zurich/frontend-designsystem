pipeline {
  agent any
  tools {nodejs "node"}
  environment {
    SLACK_CREDENTIALS = 'slack_auth_token_zhch'
    SLACK_TEAM_DOMAIN = 'zhch'
    SLACK_CHANNEL = '#frontend'
  }
  stages {
    stage('build') {
      steps {
          sh 'echo "Test build"'
          script {
              def logContent = Jenkins.getInstance()
                  .getItemByFullName(env.JOB_NAME)
                  .getBuildByNumber(
                      Integer.parseInt(env.BUILD_NUMBER))
                  .logFile.text
              env.LOG_CAT = logContent
          }

          sh 'echo "${env.LOG_CAT}"'
      }
    }
  }
  post {
    success {
      slackSend(
        tokenCredentialId: "${env.SLACK_CREDENTIALS}",
        teamDomain: "${env.SLACK_TEAM_DOMAIN}",
        channel: "${env.SLACK_CHANNEL}",
        botUser: true,
        color: 'good',
        attachments: [
          [
           text: currentBuild.rawBuild.log,
           fallback: 'Logfile',
           color: '#00FF00'
          ],
        ],
        message: "Test Success"
      )
    }
    failure {
      slackSend(
        tokenCredentialId: "${env.SLACK_CREDENTIALS}",
        teamDomain: "${env.SLACK_TEAM_DOMAIN}",
        channel: "${env.SLACK_CHANNEL}",
        botUser: true,
        color: 'danger',
        attachments: [
          [
           text: currentBuild.rawBuild.log,
           fallback: 'Logfile',
           color: '#FF0000'
          ],
        ],
        message: "Test Fail"
      )
    }
  }
}
